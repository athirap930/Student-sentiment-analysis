<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 1rem; padding: 1.5rem; transition: all 0.2s ease-in-out; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }
        .form-input { background-color: #374151; border: 1px solid #4b5563; color: #d1d5db; border-radius: 0.5rem; }
        .feedback-item { border-left-width: 4px; background-color: #1f2937; }
        .feedback-item.positive { border-color: #22c55e; }
        .feedback-item.negative { border-color: #ef4444; }
        .feedback-item.neutral { border-color: #f59e0b; }
        .btn-primary { background-color: #3b82f6; transition: background-color 0.2s ease; }
        .btn-primary:hover { background-color: #2563eb; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">Sentiment Analysis Dashboard</h1>
                <p class="text-gray-400">Visualizing Student Feedback Insights</p>
            </div>
            <div class="mt-4 sm:mt-0 flex items-center space-x-4">
                <select id="departmentFilter" class="form-input p-2"></select>
                <button id="importBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Import Data</button>
                <div class="relative" id="exportDropdownContainer">
                    <button id="exportTriggerBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Export Report</button>
                    <div id="exportDropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl z-10">
                        <a id="exportCsvBtn" href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Export as CSV</a>
                        <a id="exportExcelBtn" href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Export as Excel</a>
                        <a id="exportPdfBtn" href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Export as PDF Report</a>
                        <a id="exportZipBtn" href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Export as ZIP</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main id="dashboardContent" class="grid grid-cols-1 lg:grid-cols-4 gap-6"></main>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 modal-overlay">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 modal-content scale-95">
            <h2 class="text-xl font-bold text-white mb-4">Import Feedback Data</h2>
            <form id="importForm">
                <p class="text-gray-400 mb-4 text-sm">Upload a CSV or Excel (.xlsx) file with a header row containing at least a 'feedback_text' column.</p>
                <input type="file" id="dataFile" accept=".csv, .xlsx" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"/>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancelImportBtn" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 rounded-lg">Cancel</button>
                    <button type="submit" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg">Upload & Process</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'http://127.0.0.1:5000';
        const DEPARTMENTS = ["Computer Science", "Business Administration", "Campus Services", "Mechanical Engineering", "Arts & Humanities"];

        // Chart instances & global state
        let sentimentPieChart, trendLineChart;
        let allFeedback = [];

        // --- DOM ELEMENTS ---
        const dashboardContent = document.getElementById('dashboardContent');
        const departmentFilter = document.getElementById('departmentFilter');
        const importBtn = document.getElementById('importBtn');
        const exportTriggerBtn = document.getElementById('exportTriggerBtn');
        const exportDropdown = document.getElementById('exportDropdown');
        const importModal = document.getElementById('importModal');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const importForm = document.getElementById('importForm');
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            DEPARTMENTS.forEach(dept => departmentFilter.add(new Option(dept, dept)));
            fetchAndRender();
            departmentFilter.addEventListener('change', () => renderDashboard(allFeedback));

            // Export Dropdown Toggle
            exportTriggerBtn.addEventListener('click', () => exportDropdown.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!document.getElementById('exportDropdownContainer').contains(e.target)) {
                    exportDropdown.classList.add('hidden');
                }
            });
            
            // Setup Export Links
            setupExportLinks();

            // Import Modal Toggle
            importBtn.addEventListener('click', () => {
                importModal.classList.remove('hidden');
                setTimeout(() => {
                    importModal.classList.remove('opacity-0');
                    importModal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            });
            
            function closeModal() {
                 importModal.classList.add('opacity-0');
                 importModal.querySelector('.modal-content').classList.add('scale-95');
                 setTimeout(() => importModal.classList.add('hidden'), 300);
            }
            cancelImportBtn.addEventListener('click', closeModal);

            // Import Form Submission
            importForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('dataFile');
                if (fileInput.files.length === 0) {
                    alert('Please select a file to upload.'); return;
                }
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                try {
                    // Use the unified '/import/file' endpoint
                    const response = await fetch(`${API_URL}/import/file`, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Import failed');
                    alert(result.message);
                    closeModal();
                    fetchAndRender();
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });
        });
        
        function setupExportLinks() {
            const exportLinks = [
                { id: 'exportCsvBtn', path: '/export/csv' },
                { id: 'exportExcelBtn', path: '/export/excel' },
                { id: 'exportPdfBtn', path: '/export/pdf' },
                { id: 'exportZipBtn', path: '/export/zip' }
            ];
            exportLinks.forEach(linkInfo => {
                const btn = document.getElementById(linkInfo.id);
                if (btn) {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = `${API_URL}${linkInfo.path}`;
                        exportDropdown.classList.add('hidden');
                    });
                }
            });
        }

        // --- CORE RENDER FUNCTIONS ---
        async function fetchAndRender() {
            try {
                dashboardContent.innerHTML = `<div id="loadingState" class="col-span-full text-center p-16"><p class="text-lg">Loading Dashboard...</p></div>`;
                const [feedbackResponse, recsResponse] = await Promise.all([ fetch(`${API_URL}/feedback`), fetch(`${API_URL}/recommendations`) ]);
                if (!feedbackResponse.ok) throw new Error('Failed to fetch feedback');
                if (!recsResponse.ok) throw new Error('Failed to fetch recommendations');
                allFeedback = await feedbackResponse.json();
                const recommendations = await recsResponse.json();
                renderDashboard(allFeedback, recommendations);
            } catch (error) {
                console.error('Fetch error:', error);
                 dashboardContent.innerHTML = `<div id="errorState" class="col-span-full text-center p-16 bg-red-900/50 rounded-lg"><p class="text-lg font-bold text-red-400">Failed to load data.</p><p class="text-gray-400">Please ensure the backend server is running.</p></div>`;
            }
        }

        function renderDashboard(data, recommendations) {
            const currentFilter = departmentFilter.value;
            const filteredData = currentFilter === 'All' ? data : data.filter(item => item.department === currentFilter);
            dashboardContent.innerHTML = `
                <div id="kpiContainer" class="col-span-full grid grid-cols-2 md:grid-cols-4 gap-6"></div>
                <div class="lg:col-span-3 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 card"><h3 class="font-semibold text-white mb-4">Sentiment Distribution</h3><div class="relative h-64"><canvas id="sentimentPieChart"></canvas></div></div>
                        <div class="md:col-span-2 card"><h3 class="font-semibold text-white mb-4">Sentiment Trend</h3><div class="relative h-64"><canvas id="trendLineChart"></canvas></div></div>
                    </div>
                    <div id="keywordCloud" class="card"></div>
                    <div id="aiRecommendations" class="card"></div>
                </div>
                <div class="lg:col-span-1 space-y-6">
                     <div id="feedbackFormCard" class="card"></div>
                     <div class="card"><h2 class="text-lg font-semibold text-white mb-4">Recent Feedback</h2><ul id="recentFeedbackList" class="max-h-96 overflow-y-auto pr-2 space-y-3"></ul></div>
                </div>`;
            updateKpiCards(filteredData);
            updateSentimentPieChart(filteredData);
            updateTrendChart(data);
            updateKeywordCloud(filteredData);
            updateAiRecommendations(recommendations);
            renderFeedbackForm();
            updateRecentFeedback(filteredData);
        }
        
        // --- UI UPDATE FUNCTIONS ---
        function updateKpiCards(data) { 
            const container = document.getElementById('kpiContainer'); if (!container) return;
            const total = data.length; const positiveCount = data.filter(f => f.sentiment_category === 'Positive').length; const negativeCount = data.filter(f => f.sentiment_category === 'Negative').length; const avgScore = total > 0 ? (data.reduce((acc, item) => acc + item.sentiment_score, 0) / total).toFixed(2) : '0.00'; const positiveRate = total > 0 ? ((positiveCount / total) * 100).toFixed(1) : '0.0';
            container.innerHTML = `<div class="card"><h3 class="text-gray-400">Total Feedback</h3><p class="text-3xl font-bold text-white">${total}</p></div><div class="card"><h3 class="text-gray-400">Positive Rate</h3><p class="text-3xl font-bold text-green-400">${positiveRate}%</p></div><div class="card"><h3 class="text-gray-400">Negative Count</h3><p class="text-3xl font-bold text-red-400">${negativeCount}</p></div><div class="card"><h3 class="text-gray-400">Average Score</h3><p class="text-3xl font-bold text-blue-400">${avgScore}</p></div>`;
        }
        function updateRecentFeedback(data) {
            const list = document.getElementById('recentFeedbackList'); if (!list) return; list.innerHTML = '';
            data.slice(0, 5).forEach(item => { const displayText = item.corrected_text || item.feedback_text || 'No content'; const li = document.createElement('li'); li.className = `feedback-item p-3 rounded-md ${item.sentiment_category.toLowerCase()}`; li.innerHTML = `<p class="text-gray-300 text-sm">"${displayText}"</p><p class="text-xs text-gray-500 mt-2">${item.faculty || 'N/A'}</p>`; list.appendChild(li); });
        }
        function updateKeywordCloud(data) {
            const container = document.getElementById('keywordCloud'); if (!container) return; container.innerHTML = '<h3 class="font-semibold text-white mb-4">Keyword Analysis</h3>'; const cloudContent = document.createElement('div'); cloudContent.className = 'flex flex-wrap gap-2 items-center'; const stopWords = new Set(['a', 'an', 'the', 'is', 'was', 'it', 'in', 'on', 'for', 'to', 'of', 'course']); const wordCounts = data.reduce((acc, item) => { (item.corrected_text || item.feedback_text || '').toLowerCase().split(/\s+/).forEach(word => { const cleanWord = word.replace(/[^a-z]/g, ''); if (cleanWord && !stopWords.has(cleanWord)) { acc[cleanWord] = (acc[cleanWord] || 0) + 1; } }); return acc; }, {}); const sortedWords = Object.entries(wordCounts).sort((a, b) => b[1] - a[1]).slice(0, 15); const maxCount = sortedWords.length > 0 ? sortedWords[0][1] : 1;
            sortedWords.forEach(([word, count]) => { const span = document.createElement('span'); span.className = 'text-gray-300 bg-gray-700 rounded-md px-2 py-1'; span.style.fontSize = `${0.75 + (count / maxCount) * 0.75}rem`; span.textContent = word; cloudContent.appendChild(span); }); container.appendChild(cloudContent);
        }
        function updateAiRecommendations(recommendations) {
             const container = document.getElementById('aiRecommendations'); if(!container) return; let recsHtml = (recommendations || []).map(rec => { let formattedRec = rec.replace("💡", "").replace("🔍", "").replace("⭐", "").trim(); let icon = rec.includes("💡") ? '💡' : rec.includes("🔍") ? '🔍' : '⭐'; let colorClass = rec.includes("💡") ? 'text-green-400' : rec.includes("🔍") ? 'text-yellow-400' : 'text-blue-400'; const parts = formattedRec.split(':'); const title = parts[0] ? `<span class="${colorClass}">${parts[0]}:</span>` : ''; const body = parts.slice(1).join(':'); return `<li class="text-sm text-gray-400">${icon} ${title}${body}</li>`; }).join('');
            container.innerHTML = `<h3 class="font-semibold text-white mb-4">AI Recommendations</h3><ul class="space-y-3">${recsHtml}</ul>`;
        }
        function renderFeedbackForm() {
            const container = document.getElementById('feedbackFormCard'); if(!container) return; container.innerHTML = `<h2 class="text-lg font-semibold mb-4 text-white">Submit Feedback</h2><form id="feedbackForm" class="space-y-4"><textarea id="feedbackText" rows="4" class="w-full p-2 form-input" placeholder="e.g., my teachere was amaezing..."></textarea><button type="submit" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md">Analyze & Submit</button></form>`;
            document.getElementById('feedbackForm').addEventListener('submit', async (e) => { e.preventDefault(); const text = document.getElementById('feedbackText').value; if (!text.trim()) return; const dummyData = { feedback_text: text, department: 'Computer Science', course: 'CS101 - Intro to Programming', faculty: 'Dr. Alan Turing' }; try { const response = await fetch(`${API_URL}/feedback`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dummyData) }); if (!response.ok) throw new Error('Submission failed'); document.getElementById('feedbackText').value = ''; await fetchAndRender(); } catch (error) { console.error('Submit error:', error); alert('Failed to submit feedback.'); } });
        }
        function updateSentimentPieChart(data) {
            const ctx = document.getElementById('sentimentPieChart'); if (!ctx) return; if (sentimentPieChart) sentimentPieChart.destroy(); const counts = data.reduce((acc, item) => { acc[item.sentiment_category] = (acc[item.sentiment_category] || 0) + 1; return acc; }, { Positive: 0, Negative: 0, Neutral: 0 });
            sentimentPieChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Positive', 'Negative', 'Neutral'], datasets: [{ data: [counts.Positive, counts.Negative, counts.Neutral], backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'], borderColor: '#1f2937', borderWidth: 4, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } } });
        }
        function updateTrendChart(data) {
            const ctx = document.getElementById('trendLineChart'); if (!ctx) return; if (trendLineChart) trendLineChart.destroy(); const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const recentData = data.filter(item => item.created_at && new Date(item.created_at) >= thirtyDaysAgo); const dailyScores = recentData.reduce((acc, item) => { const date = new Date(item.created_at).toISOString().split('T')[0]; if (!acc[date]) { acc[date] = { total: 0, count: 0 }; } acc[date].total += item.sentiment_score; acc[date].count += 1; return acc; }, {}); const sortedDates = Object.keys(dailyScores).sort((a, b) => new Date(a) - new Date(b)); const labels = sortedDates; const avgData = sortedDates.map(date => dailyScores[date].total / dailyScores[date].count);
            trendLineChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Avg Score', data: avgData, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: '#3b82f6', tension: 0.3, }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#9ca3af' } }, y: { ticks: { color: '#9ca3af' } } } } });
        }
    </script>
</body>
</html>

